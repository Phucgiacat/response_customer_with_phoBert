<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Study Chat</title>
  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ===== THEME VARIABLES ===== */
    :root{
      --bg:      #f5f6fa;
      --surface: #ffffff;
      --accent1: #5e9bff;
      --accent2: #0074ff;
      --text:    #202124;
      --text-alt:#555;
      --bot:     #e7e9f1;
      --radius:  18px;
      --shadow:  0 4px 10px rgba(0,0,0,.08);
    }
    body.dark{
      --bg:      #18191c;
      --surface: #242526;
      --accent1: #009dff;
      --accent2: #0074ff;
      --text:    #e4e6eb;
      --text-alt:#b0b3b8;
      --bot:     #3a3b3c;
      --shadow:  0 4px 10px rgba(0,0,0,.45);
    }

    /* ===== RESET & GLOBAL ===== */
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0;font-family:"Inter",system-ui,sans-serif;
      background:var(--bg);color:var(--text);
      height:100vh;display:flex;flex-direction:column;
    }

    /* ===== HEADER ===== */
    header{
      height:58px;background:var(--surface);box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 1rem;z-index:1;
    }
    header h1{font-size:18px;font-weight:600;display:flex;align-items:center;gap:.4rem;}
    header h1 svg{width:22px;height:22px;fill:var(--accent2)}
    .toggle{cursor:pointer;width:38px;height:22px;border-radius:22px;background:var(--bot);position:relative;transition:all .3s;}
    .toggle::after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:var(--accent2);transition:inherit;}
    body.dark .toggle::after{left:19px}

    /* ===== CHAT AREA ===== */
    #chat-box{flex:1;padding:1.1rem .9rem;overflow-y:auto;display:flex;flex-direction:column;gap:.55rem;scroll-behavior:smooth;}
    .msg{max-width:78%;padding:.65rem .95rem;border-radius:var(--radius);line-height:1.45;font-size:15px;box-shadow:var(--shadow);display:inline-block;animation:fadeIn .25s ease-out;}
    .user{align-self:flex-end;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border-bottom-right-radius:4px;}
    .bot{align-self:flex-start;background:var(--bot);color:var(--text);border-bottom-left-radius:4px;}
    .typing{opacity:.7;font-style:italic;animation:blink 1.2s linear infinite;}
    .emotion{display:block;font-size:11px;opacity:.55;margin-top:2px;}
    @keyframes blink{50%{opacity:.15}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    /* ===== INPUT BAR ===== */
    form{display:flex;gap:.65rem;padding:.8rem 1rem;background:var(--surface);box-shadow:var(--shadow);}
    form input{flex:1;padding:.6rem .9rem;border:1px solid rgba(0,0,0,.12);border-radius:var(--radius);background:var(--bg);color:var(--text);font-size:15px;}
    form input:focus{outline:2px solid var(--accent2);}
    form button{padding:.6rem 1.3rem;border:none;border-radius:var(--radius);background:var(--accent2);color:#fff;font-weight:500;cursor:pointer;transition:opacity .2s,transform .2s;}
    form button:disabled{opacity:.5;cursor:default}
    form button:hover:not(:disabled){transform:scale(.98)}

    /* custom scrollbar */
    #chat-box::-webkit-scrollbar{width:6px}
    #chat-box::-webkit-scrollbar-thumb{background:rgba(0,0,0,.25);border-radius:3px}
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header>
    <h1>
      <!-- simple chat icon -->
      <svg viewBox="0 0 24 24"><path d="M12 3C6.48 3 2 6.58 2 11c0 2.24 1.12 4.27 2.93 5.79-.2.73-.76 2.57-.87 2.95-.14.55.16.55.34.5.14-.04 3.05-.99 4.29-1.46A13.2 13.2 0 0 0 12 18c5.52 0 10-3.58 10-8s-4.48-8-10-8z"/></svg>
      AI Study Chat
    </h1>
    <div id="themeToggle" class="toggle" title="Đổi chế độ sáng/tối"></div>
  </header>

  <!-- ===== CHAT AREA ===== -->
  <main id="chat-box"></main>

  <!-- ===== INPUT BAR ===== -->
  <form id="chat-form" autocomplete="off">
    <input id="chat-input" type="text" placeholder="Nhập tin nhắn…" />
    <button id="send-btn" type="submit">Gửi</button>
  </form>

<script>
const API_URL = 'http://localhost:8001/chat'; // đổi nếu không dùng proxy

const $box  = document.getElementById('chat-box');
const $form = document.getElementById('chat-form');
const $input= document.getElementById('chat-input');
const $btn  = document.getElementById('send-btn');

function addMsg(text, cls, emotion){
  const div=document.createElement('div');
  div.className='msg '+cls;
  div.textContent=text;
  if(emotion){
    const badge=document.createElement('span');
    badge.textContent='['+emotion+']';
    badge.className='emotion';
    div.appendChild(badge);
  }
  $box.appendChild(div);
  $box.scrollTop=$box.scrollHeight;
  return div;
}

async function sendMessage(text){
  const typingDiv=addMsg('Đang nhập…','bot typing');
  $btn.disabled=true;
  try{
    const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(!res.ok) throw new Error(await res.text());
    const data=await res.json();
    console.log('Emotion:',data.emotion);
    typingDiv.textContent=data.reply;
    typingDiv.classList.remove('typing');
    typingDiv.appendChild(Object.assign(document.createElement('span'),{textContent:'['+data.emotion+']',className:'emotion'}));
  }catch(err){
    typingDiv.textContent='⚠️ Lỗi kết nối!';
    typingDiv.classList.remove('typing');
    console.error(err);
  }finally{$btn.disabled=false;}
}

$form.addEventListener('submit',e=>{e.preventDefault();const text=$input.value.trim();if(!text)return;addMsg(text,'user');$input.value='';$input.focus();sendMessage(text);});

$input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();$form.dispatchEvent(new Event('submit'));}});

// ===== FIRST GREETING =====
window.addEventListener('DOMContentLoaded',()=>{
  // restore dark mode preference
  const saved=localStorage.getItem('theme');
  if(saved==='dark') document.body.classList.add('dark');
  // greeting
  addMsg('Xin chào! Mình là trợ lý AI của bạn. Hãy đặt câu hỏi bất kỳ nhé!','bot');
});

// ===== DARK/LIGHT TOGGLE =====
const toggle=document.getElementById('themeToggle');
function setTheme(dark){document.body.classList.toggle('dark',dark);localStorage.setItem('theme',dark?'dark':'light');}

toggle.addEventListener('click',()=>setTheme(!document.body.classList.contains('dark')));
</script>
</body>
</html>
